<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>check address</title>
    <link
      rel="stylesheet"
      href="./check-address.css"
    />
  </head>
  <body>
    <header id="main-header">
      <div id="title-select">
        <img
          id="logo"
          src="../assets/images/logo.png"
        />
        <p id="title">우리동네 대동 단결</p>
        <select id="pop-list">
          <option value="성복동">성복동</option>
          <option value="상현동">상현동</option>
          <option value="풍덕천동">풍덕천동</option>
          <option value="신봉동">신봉동</option>
          <option value="죽전동">죽전동</option>
          <option value="동천동">동천동</option>
          <option value="고기동">고기동</option>
        </select>
      </div>
      <a
        id="home-btn"
        href="../info/info.html"
        >내 정보</a
      >
    </header>
    <section id="main-section">
      <form id="main-form">
        <h1 id="image-title">주소 인증 하기</h1>
        <label id="image-label">
          <span id="image-container">신분증 사진을 업로드해 주세요.</span>
          <input
            id="image-input"
            type="file"
          />
        </label>
        <button
          type="submit"
          id="send-btn"
        >
          전송
        </button>
        <div id="send-state"></div>
      </form>
    </section>
  </body>
  <script>
    const logo = document.querySelector("#logo");
    const title = document.querySelector("#title");

    logo.addEventListener("click", () => {
      location.href = "http://localhost:3000/";
    });

    title.addEventListener("click", () => {
      location.href = "http://localhost:3000/";
    });

    const form = document.querySelector("#main-form");
    const imageInput = document.querySelector("#image-input");

    imageInput.addEventListener("change", (e) => {
      const imageContainer = document.querySelector("#image-container");

      // FileReader 객체를 생성한다. 이 객체를 통해 파일을 읽을 수 있다.
      const reader = new FileReader();
      // 읽기가 완료되었을 때 실행되는 이벤트 핸들러를 등록한다.
      reader.onload = (e) => {
        // 읽어들인 결과를 img 태그에 표시한다.
        const img = document.createElement("img");
        img.src = e.target.result;
        img.width = 300;
        img.height = 200;
        imageContainer.appendChild(img);
      };
      // readAsDataURL 메서드를 통해 파일을 읽어들인다.
      reader.readAsDataURL(e.target.files[0]);
      imageContainer.innerHTML = "";
    });

    // 주소 인증하기
    form.addEventListener("submit", async (e) => {
      try {
        // e.preventDefault()를 통해 기본 동작을 막는다.
        e.preventDefault();

        // 파일 확장자 .jpeg인지 확인
        if (
          imageInput.files[0].type !== "image/jpeg" &&
          imageInput.files[0].type !== "image/png"
        ) {
          alert("jpeg 또는 png 파일만 업로드 가능합니다.");
          return;
        }

        // FileReader 객체를 생성한다. 이 객체를 통해 파일을 읽을 수 있다.
        const reader = new FileReader();
        reader.readAsDataURL(imageInput.files[0]);
        // 읽기가 완료되었을 때 실행되는 이벤트 핸들러를 등록한다.
        reader.onloadend = async () => {
          // 읽어들인 결과를 img 태그에 표시한다.
          const base64Image = reader.result;
          // 서버에 전송하기 전 상태를 html 에 표시해준다.
          const sendState = document.querySelector("#send-state");
          sendState.innerHTML = "전송 중입니다.";
          // 서버에 이미지를 전송한다.
          const result = await fetch("http://localhost:3000/api/user/image", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: base64Image,
              email: localStorage.getItem("id"),
            }),
          });

          // 만약 결과가 ok 가 아니라면 에러를 던진다.
          if (!result.ok) {
            throw new Error("Network response was not ok.");
          }

          // 서버에서 전달받은 json 형식의 응답을 읽을 수 있는 객체 형식으로 변환한다.
          const data = await result.json();

          // 응답 결과에 따라 동작한다.
          if (data.isValid) {
            alert("주소 인증에 성공했습니다.");
            location.href = "../info/info.html";
          } else {
            alert("주소 인증에 실패했습니다.");
          }
        };
      } catch (error) {
        // 에러가 발생했다면 콘솔에 에러를 출력한다.
        console.error(error);
      }
    });
  </script>
</html>
