<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link
      rel="stylesheet"
      href="./login.css"
    />
    <title>Login</title>
    <script
      type="text/javascript"
      src="https://static.nid.naver.com/js/naverLogin_implicit-1.0.3.js"
      charset="utf-8"
    ></script>
    <script
      type="text/javascript"
      src="http://code.jquery.com/jquery-1.11.3.min.js"
    ></script>
  </head>
  <body>
    <main id="main-container">
      <header id="login-header">
        <img src="../assets/images/logo.png" />
        <h1>
          <a href="http://dongnaecomm.cafe24app.com">우리 동네 대동단결</a>
        </h1>
      </header>
      <section id="login-form">
        <h2>로그인</h2>
        <div id="naver_id_login"></div>
        <form id="login-form-field">
          <input
            placeholder="이메일"
            type="email"
          />
          <input
            placeholder="비밀번호"
            type="password"
          />
          <button type="submit">로그인</button>
        </form>
        <footer id="login-footer">
          <button id="signup-btn">회원가입</button>
          <button id="find-pw-btn">비밀번호 찾기</button>
        </footer>
      </section>
    </main>
    <script type="text/javascript">
      // 네이버 api 로그인을 위한 객체 초기화
      var naver_id_login = new naver_id_login(
        "8KXeg4eZHdnZEfoBjghJ",
        "http://dongnaecomm.cafe24app.com"
      );
      // 네이버 로그인 버튼을 생성하기 위한 설정 흰색의 100x40 크기의 버튼을 생성한다.
      var state = naver_id_login.getUniqState();
      naver_id_login.setButton("white", 100, 40);
      // 네이버 로그인을 위한 도메인을 등록한다.
      naver_id_login.setDomain("http://dongnaecomm.cafe24app.com/");
      naver_id_login.setState(state);
      naver_id_login.setPopup();
      naver_id_login.init_naver_id_login();

      // 회원가입 버튼과 비밀번호 찾기 버튼에 이벤트 리스너를 등록한다.
      const signupBtn = document.querySelector("#signup-btn");
      signupBtn.addEventListener("click", () => {
        location.href = "./signup.html";
      });

      // 비밀번호 찾기 버튼에 이벤트 리스너를 등록한다.
      const findPwBtn = document.querySelector("#find-pw-btn");
      findPwBtn.addEventListener("click", () => {
        location.href = "./findpw.html";
      });

      // 로그인 버튼에 이벤트 리스너를 등록한다.
      const loginForm = document.querySelector("#login-form-field");
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = e.target[0].value;
        const password = e.target[1].value;
        const result = await fetch(
          "http://dongnaecomm.cafe24app.com/api/user/signin",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              password,
            }),
          }
        );

        // json() 을 통해 전달 받은 json 형식의 응답을 읽을 수 있는 객체 형식으로 변환한다.
        const data = await result.json();
        if (result.ok) {
          // 응답의 결과가 ok 이면서 isValid 의 값이 true 라면 로그인에 성공
          if (data.isValid) {
            // local스토리지에 이메일을 저장한다.
            window.localStorage.setItem("id", email);
            location.href = "http://dongnaecomm.cafe24app.com/";
          } else {
            alert(data.message);
          }
        } else {
          alert(data.message);
        }
      });
    </script>
  </body>
</html>
