<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>My info page</title>
    <link
      rel="stylesheet"
      href="info.css"
    />
  </head>
  <body>
    <header id="main-header">
      <div id="title-select">
        <img
          id="logo"
          src="../assets/images/logo.png"
        />
        <p id="title">우리동네 대동 단결</p>
        <select id="pop-list">
          <option value="성복동">성복동</option>
          <option value="상현동">상현동</option>
          <option value="풍덕천동">풍덕천동</option>
          <option value="신봉동">신봉동</option>
          <option value="죽전동">죽전동</option>
          <option value="동천동">동천동</option>
          <option value="고기동">고기동</option>
        </select>
      </div>
      <button id="home-btn">홈으로</button>
    </header>
    <main id="info-main">
      <h2 id="info-title">내 정보</h2>
      <form id="check-pw-container">
        <label>정보 확인을 위해 비밀번호를 입력해 주세요:</label>
        <input type="password" />
        <button>확인</button>
      </form>
      <section id="user-info-container">
        <div id="user-name"></div>
        <div id="user-nickname"></div>
        <div id="user-email"></div>
        <div id="user-address-container">
          <div id="user-address"></div>
          <a
            id="add-address-btn"
            href="../auth/check-address.html"
            >인증하기</a
          >
        </div>
        <button id="delete-user-btn">탈퇴하기</button>
      </section>
      <section id="user-post-container">
        <h2>내가 쓴 글</h2>
        <ul id="user-post-list"></ul>
      </section>
    </main>
    <div id="delete-modal">
      <div id="delete-modal-content">
        <p>정말로 탈퇴하시겠습니까?</p>
        <button id="delete-modal-cancel-btn">취소</button>
        <button id="delete-modal-delete-btn">탈퇴</button>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    const logo = document.querySelector("#logo");
    const title = document.querySelector("#title");

    logo.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    title.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    // 홈으로 버튼에 이벤트 리스너를 등록한다.
    const homeBtn = document.querySelector("#home-btn");
    homeBtn.addEventListener("click", () => {
      location.href = "/";
    });

    // 정보 확인을 위한 비밀번호를 입력하고 확인 버튼을 누르면
    const checkPwContainer = document.querySelector("#check-pw-container");
    const userContainer = document.querySelector("#user-info-container");
    const deleteBtn = document.querySelector("#delete-user-btn");

    deleteBtn.addEventListener("click", async () => {
      try {
        const modal = document.querySelector("#delete-modal");
        modal.style.display = "block";
      } catch (err) {
        console.error(err);
      }
    });

    const deleteModalCancelBtn = document.querySelector(
      "#delete-modal-cancel-btn"
    );
    deleteModalCancelBtn.addEventListener("click", () => {
      const modal = document.querySelector("#delete-modal");
      modal.style.display = "none";
    });

    const deleteModalDeleteBtn = document.querySelector(
      "#delete-modal-delete-btn"
    );

    deleteModalDeleteBtn.addEventListener("click", async () => {
      try {
        const email = localStorage.getItem("id");
        const result = await fetch(
          "http://dongnaecomm.cafe24app.com/api/user/delete",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          }
        );
        const data = await result.json();
        if (data.success) {
          localStorage.removeItem("id");
          alert("탈퇴가 완료되었습니다.");
          location.href = "/";
        }
      } catch (err) {
        console.error(err);
      }
    });

    checkPwContainer.addEventListener("submit", async (e) => {
      try {
        e.preventDefault();
        // 비밀번호를 가져온다.
        const password = checkPwContainer.querySelector(
          "input[type=password]"
        ).value;
        // 이메일을 가져온다.
        const email = localStorage.getItem("id");
        // 비밀번호와 이메일을 서버에 보내서 비밀번호가 일치하는지 확인한다.
        const result = await fetch(
          "http://dongnaecomm.cafe24app.com/api/user/checkpw",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password, email }),
          }
        );
        const data = await result.json();
        // 유효하다면 사용자 정보를 가져온다.
        if (data.isValid) {
          userContainer.style.display = "block";
          checkPwContainer.style.display = "none";

          const userName = document.querySelector("#user-name");
          const userNickname = document.querySelector("#user-nickname");
          const userEmail = document.querySelector("#user-email");
          const userAddress = document.querySelector("#user-address");
          const userPostList = document.querySelector("#user-post-list");
          const userPostContainer = document.querySelector(
            "#user-post-container"
          );

          // 사용자 정보를 가져와서 화면에 표시한다.
          userName.textContent = `이름: ${data.name}`;
          userNickname.textContent = `닉네임: ${data.nickname}`;
          userEmail.textContent = `이메일: ${data.email}`;
          deleteBtn.style.display = "block";

          userPostContainer.style.visibility = "visible";

          // 사용자가 작성한 글을 가져와서 화면에 표시한다.
          data?.posts?.forEach((post) => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = `../post/detail.html?id=${post.post_id}`;
            a.textContent = post.title;
            li.appendChild(a);
            userPostList.appendChild(li);
          });

          // 사용자의 주소를 가져와서 화면에 표시한다.
          const address = data.address;

          // 주소가 없다면 인증하기 버튼을 표시한다.
          if (address === "0" || address === null) {
            userAddress.textContent = `주소: 인증되지 않은 사용자입니다.`;
            const addAddressBtn = document.querySelector("#add-address-btn");
            addAddressBtn.style.display = "block";
            return;
          } else {
            const addAddressBtn = document.querySelector("#add-address-btn");
            addAddressBtn.style.display = "none";
          }
          userAddress.textContent = `주소: ${address}`;
        } else {
          alert("비밀번호가 일치하지 않습니다.");
        }
      } catch (err) {
        console.error(err);
      }
    });
  </script>
</html>
