<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>post detail page</title>
    <script src="/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="./detail.css"
    />
  </head>
  <body>
    <header id="main-header">
      <div id="title-select">
        <img
          id="logo"
          src="../assets/images/logo.png"
        />
        <p id="title">우리동네 대동 단결</p>
        <select id="pop-list">
          <option value="성복동">성복동</option>
          <option value="상현동">상현동</option>
          <option value="풍덕천동">풍덕천동</option>
          <option value="신봉동">신봉동</option>
          <option value="죽전동">죽전동</option>
          <option value="동천동">동천동</option>
          <option value="고기동">고기동</option>
        </select>
      </div>
      <div style="display: flex; flex-direction: row; gap: 1rem">
        <button id="go-back-btn">뒤로가기</button>
        <button id="my-home-btn">홈으로</button>
      </div>
    </header>
    <main id="main"></main>
    <form id="chat-list">
      <p>실시간 채팅</p>
      <ul id="chat-items"></ul>
      <footer id="chat-footer">
        <input
          placeholder="메시지를 입력하세요."
          id="chat-input"
          type="text"
        />
        <div>
          <button
            type="button"
            id="chat-close-btn"
          >
            닫기
          </button>
          <button
            type="submit"
            id="chat-send-btn"
          >
            전송
          </button>
        </div>
      </footer>
    </form>
    <div id="edit-post-modal">
      <div id="edit-modal-content">
        <form id="edit-form">
          <input
            id="edit-title-input"
            type="text"
          />
          <textarea
            name="content"
            id="edit-content"
            cols="30"
            rows="10"
          ></textarea>
          <input
            placeholder="이미지 변경 또는 업로드"
            type="file"
            id="edit-image"
          /><button
            type="button"
            id="delete-image-btn"
          >
            이미지 제거
          </button>
          <button
            type="button"
            id="edit-cancle-btn"
          >
            취소
          </button>
          <button
            type="submit"
            id="edit-submit-btn"
          >
            수정
          </button>
        </form>
      </div>
    </div>
    <div id="delete-modal">
      <div id="delete-modal-content">
        <p>정말로 삭제하시겠습니까?</p>
        <div id="delete-modal-btn-list">
          <button id="delete-modal-confirm-btn">확인</button>
          <button id="delete-modal-cancel-btn">취소</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    const deleteImageBtn = document.getElementById("delete-image-btn");

    deleteImageBtn &&
      deleteImageBtn.addEventListener("click", async () => {
        try {
          const postId = new URLSearchParams(location.search).get("id");
          const response = await fetch(
            `http://dongnaecomm.cafe24app.com/api/post/image/${postId}`,
            {
              method: "DELETE",
            }
          );
          const data = await response.json();
          if (data.success) {
            alert("이미지가 삭제되었습니다.");
            location.reload();
          } else {
            alert("이미지 삭제에 실패했습니다.");
          }
        } catch (error) {
          console.error(error);
        }
      });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
      });
    }

    const logo = document.querySelector("#logo");
    const title = document.querySelector("#title");

    logo.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    title.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    // 채팅 기능 관련 요소 받아오기
    const chatCloseBtn = document.querySelector("#chat-close-btn");
    const chatList = document.querySelector("#chat-list");
    const chatSendBtn = document.querySelector("#chat-send-btn");
    const chatInput = document.querySelector("#chat-input");
    const chatItems = document.querySelector("#chat-items");

    // 채팅 종료 버튼 이벤트 리스너 등록
    chatCloseBtn.addEventListener("click", () => {
      chatList.style.display = "none";
    });

    // 소켓 통신 시작
    const socket = io("http://dongnaecomm.cafe24app.com");

    // 주소창 주소 파라미터에서 id 가져오기
    const email = localStorage.getItem("id");

    const postId = new URLSearchParams(location.search).get("id");

    // 채팅방 입장
    socket.emit("joinRoom", postId);

    // 이전 메시지 불러오기
    socket.on("previousMessages", (messages) => {
      messages.forEach((message) => {
        addMessageToChatList(message);
      });
    });

    // 메시지 수신
    socket.on("receiveMessage", (message) => {
      addMessageToChatList(message);
    });

    // 메시지 전송 함수
    function sendMessage(content) {
      const userEmail = localStorage.getItem("id"); // 사용자 닉네임 가져오기
      if (!userEmail) {
        alert("로그인이 필요한 기능입니다.");
        return;
      }
      socket.emit("sendMessage", { postId, content, userEmail });
    }

    // 메시지를 채팅 리스트에 추가하는 함수
    function addMessageToChatList(message) {
      const li = document.createElement("li");
      // 메시지를 채팅 리스트에 추가한다.
      li.textContent = `${message.userNickName ?? message.user_nickname}: ${
        message.content
      }`;
      // 채팅 리스트에 추가한다.
      chatItems.appendChild(li);
      // 채팅 리스트의 스크롤을 맨 아래로 내린다.
      chatItems.scrollTop = chatItems.scrollHeight;
    }

    // 메시지 전송 버튼 이벤트 리스너 등록
    chatList.addEventListener("submit", (e) => {
      e.preventDefault();
      const content = chatInput.value;
      if (content.length === 0) {
        alert("메시지를 최소 1글자 이상 입력해주세요.");
        return;
      }
      // 전송 버튼 클릭시 아래 함수 실행
      sendMessage(content);
      chatInput.value = "";
    });

    const goBackBtn = document.querySelector("#go-back-btn");
    const myHomeBtn = document.querySelector("#my-home-btn");

    // 뒤로가기 버튼 이벤트 리스너 등록
    goBackBtn.addEventListener("click", () => {
      history.back();
    });

    // 홈으로 버튼 이벤트 리스너 등록
    myHomeBtn.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    // 날짜 포맷팅 함수
    function getFormattedDate(date) {
      const newDate = new Date(date);
      const year = newDate.getFullYear();
      const month = newDate.getMonth() + 1;
      const day = newDate.getDate();
      return `${year}년 ${month}월 ${day}일`;
    }

    // 게시글 상세 정보를 가져오는 함수
    async function getPostDetail() {
      const email = localStorage.getItem("id");
      const postId = new URLSearchParams(location.search).get("id");
      const response = await fetch(
        `http://dongnaecomm.cafe24app.com/api/post/get/${postId}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
          }),
        }
      );
      const data = await response.json();
      const main = document.querySelector("#main");
      const postDetail = document.createElement("div");
      // 받아온 데이터를 토대로 html 추가
      postDetail.innerHTML = `
      <div id="post-container">
        <div id="post-top-banner">
          <div>
            <h1 id="post-title">${data.post.title}</h1>
          <div id="post-info">
            <p id="post-owner">글쓴이: ${data.user.nick_name}</p>
            <p>작성일자: ${getFormattedDate(data.post.reg_date)}</p>
            <p>조회수: ${data.post.view_count}</p>
          </div>
          </div>
          <div id="manifulate-btn">
          ${
            localStorage.getItem("id") === data.user.id
              ? `
          <button id="edit-btn">수정</button>
          <button id="delete-btn">삭제</button>
          <button id="pickup-btn">끌올</button>
          `
              : ""
          }

        </div>
        </div>
        <div id="post-container">
          <div>
            <p id="post-content">${data.post.content}</p>
          ${
            data.post.image
              ? `<img id="post-img" src="http://dongnaecomm.cafe24app.com/api/post/image/${postId}" alt="Post Image" />`
              : ``
          }
            </div>
          <button id="favorite-btn">추천하기 ${
            data.post.favorite_count
          }</button>
          
        </div>
        <section>
          <h4>댓글</h4>
          <form id="comment-form">
            <input id="comment-input" type="text" />
            <div id="comment-btn-list">
              <button type="button" id="open-chat-btn">실시간 채팅</button>
              <button type="submit" id="comment-btn">등록</button>
              </div>
          </form>
          <ul id="comment-list">
          </ul>
        </section>
      </div>
      `;
      main.appendChild(postDetail);

      // 댓글 리스트 요소 받아오기
      const commentList = document.querySelector("#comment-list");

      // 댓글 리스트 HTML에 추가
      data.comments.forEach((comment) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <p id="comment-nickname">${comment.owner_nickname}</p>
          <p id="comment-content">${comment.content}</p>
          <div>
            ${
              localStorage.getItem("id") === comment.owner_Id
                ? `
              <button class="comment-delete-btn" id="comment-delete-btn-${comment.comment_id}">삭제</button>
              `
                : ""
            }
          <div>
        `;
        commentList.appendChild(li);
        const commentDeleteBtn = document.querySelector(
          `#comment-delete-btn-${comment.comment_id}`
        );

        // 댓글 삭제 버튼 이벤트 리스너 등록
        commentDeleteBtn.addEventListener("click", async () => {
          try {
            const response = await fetch(
              `http://dongnaecomm.cafe24app.com/api/post/${postId}/comment/${comment.comment_id}`,
              {
                method: "DELETE",
              }
            );
            const data = await response.json();
            if (data.success) {
              location.reload();
            }
          } catch (error) {}
        });
      });
    }
    // 게시글 상세 정보를 가져온 이후의 동작
    getPostDetail().then(() => {
      const pickupBtn = document.querySelector("#pickup-btn");
      pickupBtn &&
        pickupBtn.addEventListener("click", async () => {
          try {
            const postId = new URLSearchParams(location.search).get("id");
            const response = await fetch(
              `http://dongnaecomm.cafe24app.com/api/post/${postId}/pickup`,
              {
                method: "PATCH",
              }
            );
            const data = await response.json();
            if (data.success) {
              alert("끌올되었습니다.");
              location.reload();
            } else {
              alert("끌올이 불가능한 게시글입니다.");
            }
          } catch (error) {}
        });
      const openChatBtn = document.querySelector("#open-chat-btn");
      const chatList = document.querySelector("#chat-list");

      openChatBtn.addEventListener("click", async () => {
        try {
          const postId = new URLSearchParams(location.search).get("id");

          const email = localStorage.getItem("id");
          const canChat = await fetch(
            "http://dongnaecomm.cafe24app.com/api/user/checkcancomment",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                postId,
                email,
              }),
            }
          );

          if (!canChat.ok) {
            throw new Error(
              "댓글을 달 수 있는 권한이 없습니다. 주소를 확인해주세요."
            );
          }
          const canChatResult = await canChat.json();

          console.log(canChatResult);

          if (!canChatResult.success) {
            alert("댓글을 달 수 있는 권한이 없습니다. 주소를 확인해주세요.");
            return;
          }
          chatList.style.display = "block";
        } catch (error) {
          console.error(error);
          alert("알수없는 오류로 실패했습니다.");
          return;
        }
      });
      // 필요한 요소 변수에 할당
      const editBtn = document.querySelector("#edit-btn");
      const deleteBtn = document.querySelector("#delete-btn");
      const editPostModal = document.querySelector("#edit-post-modal");
      const editModalContent = document.querySelector("#edit-modal-content");
      const editForm = document.querySelector("#edit-form");
      const editTitleInput = document.querySelector("#edit-title-input");
      const editContent = document.querySelector("#edit-content");
      const editCancleBtn = document.querySelector("#edit-cancle-btn");
      const editSubmitBtn = document.querySelector("#edit-submit-btn");
      const editImageInput = document.querySelector("#edit-image");
      const deleteModal = document.querySelector("#delete-modal");
      const favoriteBtn = document.querySelector("#favorite-btn");

      // 추천하기 버튼 이벤트 리스너 등록
      favoriteBtn.addEventListener("click", async () => {
        try {
          const email = localStorage.getItem("id");
          const postId = new URLSearchParams(location.search).get("id");
          const response = await fetch(
            `http://dongnaecomm.cafe24app.com/api/post/${postId}/favorite/count`,
            {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email,
              }),
            }
          );
          const data = await response.json();
          if (data.success) {
            location.reload();
          } else {
            alert("이미 추천한 게시글입니다.");
          }
        } catch (error) {}
      });

      const deleteModalContent = document.querySelector(
        "#delete-modal-content"
      );
      const deleteModalConfirmBtn = document.querySelector(
        "#delete-modal-confirm-btn"
      );
      const deleteModalCancelBtn = document.querySelector(
        "#delete-modal-cancel-btn"
      );

      // 수정하기 버튼 이벤트 리스너 등록
      deleteModalCancelBtn &&
        deleteModalCancelBtn.addEventListener("click", () => {
          deleteModal.style.display = "none";
        });

      // 수정 취소 버튼 이벤트 리스너 등록
      editCancleBtn &&
        editCancleBtn.addEventListener("click", () => {
          editPostModal.style.display = "none";
        });

      // 수정하기 버튼 이벤트 리스너 등록
      editBtn &&
        editBtn.addEventListener("click", () => {
          editPostModal.style.display = "flex";
          editTitleInput.value =
            document.querySelector("#post-title").textContent;
          editContent.value =
            document.querySelector("#post-content").textContent;
          const image = document.querySelector("#post-img");
          if (image) {
            editImageInput.value = image.src;
          }
        });

      // 수정하기 모달창 이벤트 리스너 등록 이외의 부분 클릭시 모달창이 닫히도록 한다.
      editPostModal &&
        editPostModal.addEventListener("click", (e) => {
          if (e.target === editPostModal) {
            editPostModal.style.display = "none";
          }
        });

      // 수정하기 버튼 클릭시 form 이벤트 리스너 등록
      editForm &&
        editForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const postId = new URLSearchParams(location.search).get("id");
            if (editTitleInput.value.length === 0) {
              alert("제목을 최소 1글자 이상 입력해주세요.");
              return;
            }

            if (editContent.value.length === 0) {
              alert("내용을 최소 1글자 이상 입력해주세요.");
              return;
            }
            const imageInput = document.querySelector("#edit-image");
            // jpeg가 아니라면 업로드 불가
            if (
              imageInput.files[0] &&
              imageInput?.files[0]?.type !== "image/jpeg" &&
              imageInput?.files[0]?.type !== "image/png"
            ) {
              alert("jpeg 또는 png파일만 업로드 가능합니다.");
              return;
            }

            let base64Image;

            if (imageInput?.files?.length > 0) {
              const file = imageInput?.files[0];
              base64Image = await toBase64(file);
            } else {
              base64Image = null;
            }

            if (base64Image) {
              const imgResponse = await fetch(
                `http://dongnaecomm.cafe24app.com/api/post/image/${postId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    image: base64Image,
                  }),
                }
              );
            }

            const response = await fetch(
              `http://dongnaecomm.cafe24app.com/api/post/${postId}`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  title: editTitleInput.value,
                  content: editContent.value,
                }),
              }
            );
            const data = await response.json();
            if (data.success) {
              // 성공했다면 새로고침
              location.reload();
            }
          } catch (error) {
            console.error(error);
            alert("수정에 실패했습니다.");
          }
        });

      // 삭제하기 버튼 클릭시 모달창 오픈
      deleteBtn &&
        deleteBtn.addEventListener("click", () => {
          deleteModal.style.display = "block";
        });

      // 모달창 이외의 범위 클릭시 모달창 닫히도록 이벤트 리스너 등록
      deleteModal &&
        deleteModal.addEventListener("click", (e) => {
          if (e.target === deleteModal) {
            deleteModal.style.display = "none";
          }
        });

      // 삭제하기 버튼 클릭시 삭제 요청
      deleteModalConfirmBtn &&
        deleteModalConfirmBtn.addEventListener("click", async () => {
          try {
            const postId = new URLSearchParams(location.search).get("id");
            const response = await fetch(
              `http://dongnaecomm.cafe24app.com/api/post/${postId}`,
              {
                method: "DELETE",
              }
            );
            const data = await response.json();
            if (data.success) {
              // 포스트 삭제 이후 홈으로 돌아가기
              location.href = `http://dongnaecomm.cafe24app.com/`;
            }
          } catch (error) {}
        });

      // 댓글 등록 버튼 이벤트 리스너 등록
      const commentForm = document.querySelector("#comment-form");
      commentForm &&
        commentForm?.addEventListener("submit", async (e) => {
          // 댓글 등록 요청
          try {
            e.preventDefault();
            console.log("send");
            const postId = new URLSearchParams(location.search).get("id");
            const checkCanComment = await fetch(
              "http://dongnaecomm.cafe24app.com/api/user/checkcancomment",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  postId,
                  email: localStorage.getItem("id"),
                }),
              }
            );
            const checkResult = await checkCanComment.json();

            if (!checkResult.success) {
              alert("댓글을 달 수 있는 권한이 없습니다. 주소를 확인해주세요.");
              return;
            }
            const commentInput = document.querySelector("#comment-input");
            // localStorage 에서 이메일 가져오기
            const email = localStorage.getItem("id");
            // 이메일이 없다면 로그인이 필요하다는 메시지를 띄우고 댓글을 등록하지 않는다.
            if (!email) {
              alert("로그인이 필요한 기능입니다.");
              commentInput.value = "";
              return;
            }

            if (commentInput.value.length === 0) {
              alert("댓글을 최소 1글자 이상 입력해주세요.");
              return;
            }

            const response = await fetch(
              `http://dongnaecomm.cafe24app.com/api/post/${postId}/comment`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  content: commentInput.value,
                  email,
                }),
              }
            );
            const data = await response.json();
            if (data.success) {
              location.reload();
            }
          } catch (error) {}
        });
    });
  </script>
</html>
