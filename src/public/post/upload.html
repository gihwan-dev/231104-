<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>make post</title>
    <link
      rel="stylesheet"
      href="./upload.css"
    />
  </head>
  <body>
    <header id="main-header">
      <div id="title-select">
        <img
          id="logo"
          src="../assets/images/logo.png"
        />
        <p id="title">우리동네 대동 단결</p>
        <select id="pop-list">
          <option value="성복동">성복동</option>
          <option value="상현동">상현동</option>
          <option value="풍덕천동">풍덕천동</option>
          <option value="신봉동">신봉동</option>
          <option value="죽전동">죽전동</option>
          <option value="동천동">동천동</option>
          <option value="고기동">고기동</option>
        </select>
      </div>

      <div>
        <button id="home-btn">홈으로</button>
        <button id="go-back-btn">뒤로가기</button>
      </div>
    </header>
    <main id="main">
      <header>
        <h3 id="category-text"></h3>
      </header>
      <form id="form">
        <input
          placeholder="제목"
          id="title-input"
        />
        <textarea
          name="content"
          id="content"
          cols="30"
          rows="10"
        ></textarea>
        <div id="image-upload-container">
          <label>이미지 업로드</label>
          <input
            id="image-upload-input"
            type="file"
          />
        </div>
        <button
          type="submit"
          id="submit-btn"
        >
          등록
        </button>
      </form>
    </main>
  </body>
  <script>
    const logo = document.querySelector("#logo");
    const titleText = document.querySelector("#title");

    logo.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    titleText.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    const homeBtn = document.querySelector("#home-btn");
    homeBtn.addEventListener("click", () => {
      location.href = "http://dongnaecomm.cafe24app.com/";
    });

    const goBackBtn = document.querySelector("#go-back-btn");
    goBackBtn.addEventListener("click", () => {
      history.back();
    });

    // 셀렉트값 갱신 쿼리 파라미터의 area이랑 같은 값으로 디폴트값 갱신
    const area = new URLSearchParams(location.search).get("area");
    const popList = document.querySelector("#pop-list");
    popList.value = area;

    // 등록 누르면 제출
    // category 파라미터 = 1, 2, 3
    // area 파라미터 = 1, 2, 3, 4, 5, 6, 7
    const submitBtn = document.querySelector("#submit-btn");
    const form = document.querySelector("#form");
    const title = document.querySelector("#title-input");
    const content = document.querySelector("#content");
    const categoryText = document.querySelector("#category-text");
    const category = new URLSearchParams(location.search).get("category");
    categoryText.innerText = getCategory(category);

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
      });
    }

    // post 등록
    form.addEventListener("submit", async (e) => {
      try {
        e.preventDefault();
        const email = localStorage.getItem("id");

        const imageInput = document.querySelector("#image-upload-input");

        if (!email) {
          alert("로그인이 필요합니다.");
          return;
        }

        // jpeg가 아니라면 업로드 불가
        if (
          imageInput.files[0] &&
          imageInput?.files[0]?.type !== "image/jpeg" &&
          imageInput?.files[0]?.type !== "image/png"
        ) {
          alert("jpeg 또는 png파일만 업로드 가능합니다.");
          return;
        }

        let base64Image;

        if (imageInput.files.length > 0) {
          const file = imageInput.files[0];
          base64Image = await toBase64(file);
        } else {
          base64Image = null;
        }
        if (title.value.length === 0) {
          alert("제목을 입력해주세요.");
          return;
        }

        if (content.value.length === 0) {
          alert("내용을 입력해주세요.");
          return;
        }

        const res = await fetch("http://dongnaecomm.cafe24app.com/api/post", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
            title: title.value,
            content: content.value,
            category: category,
            image: base64Image,
          }),
        });
        const data = await res.json();
        if (data.success) {
          alert("등록되었습니다.");
          location.href = `../post/post.html?category=${category}&area=${area}`;
        } else {
          alert("등록에 실패했습니다.");
        }
      } catch (error) {
        console.error(error);
        alert("등록에 실패했습니다.");
      }
    });

    // 1 ~ 3에 따라 게시판 받기
    function getCategory(value) {
      switch (value) {
        case "1":
          return "자유게시판";
        case "2":
          return "중고거래";
        case "3":
          return "이벤트";
      }
    }
  </script>
</html>
